# JSでスタイルをいじる時

<!-- more -->

　JSでスタイルを意味するオブジェクト([CSSStyleDeclaration][])を取得する方法は以下３通りある。

-|API|コード例|違い
-|---|--------|----
1|[style][]|`el.style`|HTMLインライン`<p style="...">`
2|[getComputedStyle()][]|`getComputedStyle(el)`|CSS再計算
3|[CSSStyleSheet][]|`document.styleSheets[0].cssRules[0].style`|CSS文書

[CSSStyleDeclaration]:https://developer.mozilla.org/ja/docs/Web/API/CSSStyleDeclaration
[CSSStyleSheet]:https://developer.mozilla.org/ja/docs/Web/API/CSSStyleSheet
[getComputedStyle()]:https://developer.mozilla.org/ja/docs/Web/API/Window/getComputedStyle
[style]:https://developer.mozilla.org/ja/docs/Web/API/HTMLElement/style

　基本的には[style][]を使う。これはHTMLの`style`インライン属性値を取得・設定する。

```javascript
el.style.display = 'none'
```

　スタイルはHTMLのインライン属性値に加え、CSS文書の影響も受ける。最終的なスタイルの結果は[getComputedStyle()][]で取得できる。ただしCSSを再計算するためコストが高い。

```javascript
getComputedStyle(el).display
```

　[getComputedStyle()][]が返すスタイルでは値をセットできない。読取専用である。もしセットすると例外発生する。

```javascript
getComputedStyle(el).display = 'none'
```
```
DOMException: Failed to set the 'display' property on 'CSSStyleDeclaration': These styles are computed, and therefore the 'display' property is read-only.
```

　[CSSカスタムプロパティ][]を取得・設定するときは次のようにする。

```javascript
getComputedStyle(el).getPropertyValue('--my-prop')
el.style.getPropertyValue('--my-prop')
```
```javascript
el.style.setProperty('--my-prop', 'value')
```

　ここで気になるのが[style][]と[getComputedStyle()][]の使い分けだ。

　もしHTMLインラインだけでいいなら[style][]で足りる。CSS文書の影響も受けるなら[getComputedStyle()][]を使う。

　[CSSカスタムプロパティ][]の場合は`:root`要素で扱うのが一般的だ。HTMLでいうと`<html>`要素の`style`属性値になる。

```html
<html style="--my-prop: value;">
```

　これなら[setAttribute()][]でも変更できそうだが、対象以外のプロパティも含んだ文字列として扱わねばならないため面倒。

[getAttribute()]:https://developer.mozilla.org/ja/docs/Web/API/Element/getAttribute
[setAttribute()]:https://developer.mozilla.org/ja/docs/Web/API/Element/setAttribute
[removeAttribute()]:https://developer.mozilla.org/ja/docs/Web/API/Element/removeAttribute

```javascript
el.setAttribute('style', '--my-prop: newValue;')
```

　なので[style][]を使い、[getPropertyValue][]/[setProperty][]で個別に設定・取得したほうが扱いやすい。

```javascript
el.style.getPropertyValue('--my-prop')
el.style.setProperty('--my-prop', 'value')
```

　[getComputedStyle()][]は文書に追加された要素のみ有効。なので要素を動的生成して、[CSSカスタムプロパティ][]をインラインにセットしても、[getComputedStyle()][]からは取得できない。

```javascript
const el = document.createElement('p')
el.style.setProperty('--my-prop', 'value')
// OK
console.assert('value'===el.style.getPropertyValue('--my-prop'))
// エラー！
console.assert('value'===getComputedStyle(el).getPropertyValue('--my-prop'))
```

[createElement()]:https://developer.mozilla.org/ja/docs/Web/API/Document/createElement
[append()]:https://developer.mozilla.org/ja/docs/Web/API/Element/append

　[getComputedStyle()][]が有用なのはCSS再計算が必要な場合である。例えばCSS関数[calc()][]を使っている場合。

[calc()]:https://developer.mozilla.org/ja/docs/Web/CSS/calc

```html
<p id="target"></p>
```
```css
:root {
  --x: 20px;
  --y: 5px;
}
#target {
  font-size: calc(var(--x) + var(--y));
}
```
```javascript
const R = document.querySelector(':root');
const T = document.querySelector('#target');

// ''が返る
R.style.fontSize
T.style.fontSize
R.style.getPropertyValue('--x')
R.style.getPropertyValue('--y')
T.style.getPropertyValue('--x')
T.style.getPropertyValue('--y')

// 16px,20px,5px 
getComputedStyle(R).fontSize
getComputedStyle(R).getPropertyValue('--x')
getComputedStyle(R).getPropertyValue('--y')

// 25px,20px,5px 
getComputedStyle(T).fontSize
getComputedStyle(T).getPropertyValue('--x')
getComputedStyle(T).getPropertyValue('--y')
```

　[style][]は空文字`''`が返る。HTMLインラインに設定された値は存在しないため。このようにHTMLインラインに設定がなく、CSSに設定がある場合は、[style][]でなく[getComputedStyle()][]で取得する必要がある。

　とはいえ[getComputedStyle()][]はCSS再計算するためコストが高い。よって場合により使い分けるのが最善。

　[getComputedStyle()][]では正しい値が返っている。`:root`には`font-size`の設定がないためデフォルト値の`16px`が返る。それ以外は指定した通りの値が返る。
   
　





















R.style.setProperty('--x', '20px')


const T = document.querySelector('#target:after')
// OK
console.assert('value'===T.style.getPropertyValue('--my-prop'))
// エラー！
console.assert('value'===getComputedStyle(T).getPropertyValue('--my-prop'))
```

　[style][]だけで十分足りる気がする。



[CSSカスタムプロパティ]:https://developer.mozilla.org/ja/docs/Web/CSS/Using_CSS_custom_properties
[getPropertyValue()]:https://developer.mozilla.org/ja/docs/Web/API/CSSStyleDeclaration/getPropertyValue
[setProperty()]:https://developer.mozilla.org/ja/docs/Web/API/CSSStyleDeclaration/setProperty

```javascript
getComputedStyle(t).getPropertyValue('--my-prop')
t.style.setProperty('--my-prop', 'value')
```
```javascript
document.styleSheets[0].cssRules[0].style
```

　CSS文書を変更したい場合はあまりない。

